'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = undefined;

var _classCallCheck2 = require('babel-runtime/helpers/classCallCheck');

var _classCallCheck3 = _interopRequireDefault(_classCallCheck2);

var _possibleConstructorReturn2 = require('babel-runtime/helpers/possibleConstructorReturn');

var _possibleConstructorReturn3 = _interopRequireDefault(_possibleConstructorReturn2);

var _inherits2 = require('babel-runtime/helpers/inherits');

var _inherits3 = _interopRequireDefault(_inherits2);

var _clone = require('lodash/clone');

var _clone2 = _interopRequireDefault(_clone);

var _QueryBuilderOperation = require('./QueryBuilderOperation');

var _QueryBuilderOperation2 = _interopRequireDefault(_QueryBuilderOperation);

var _promiseUtils = require('../../utils/promiseUtils');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var UpdateOperation = function (_QueryBuilderOperatio) {
  (0, _inherits3.default)(UpdateOperation, _QueryBuilderOperatio);

  function UpdateOperation(name, opt) {
    (0, _classCallCheck3.default)(this, UpdateOperation);

    var _this = (0, _possibleConstructorReturn3.default)(this, _QueryBuilderOperatio.call(this, name, opt));

    _this.model = null;
    _this.modelOptions = (0, _clone2.default)(_this.opt.modelOptions) || {};
    _this.isWriteOperation = true;
    return _this;
  }

  UpdateOperation.prototype.call = function call(builder, args) {
    this.model = builder.modelClass().ensureModel(args[0], this.modelOptions);
    return true;
  };

  UpdateOperation.prototype.onBeforeInternal = function onBeforeInternal(builder, result) {
    var maybePromise = this.model.$beforeUpdate(this.modelOptions, builder.context());
    return (0, _promiseUtils.afterReturn)(maybePromise, result);
  };

  UpdateOperation.prototype.onBuild = function onBuild(knexBuilder, builder) {
    var json = this.model.$toDatabaseJson();
    var cols = builder.modelClass().getIdColumnArray();

    for (var i = 0, l = cols.length; i < l; ++i) {
      var col = cols[i];
      delete json[col];
    }

    knexBuilder.update(json);
  };

  UpdateOperation.prototype.onAfterInternal = function onAfterInternal(builder, numUpdated) {
    var maybePromise = this.model.$afterUpdate(this.modelOptions, builder.context());
    return (0, _promiseUtils.afterReturn)(maybePromise, numUpdated);
  };

  return UpdateOperation;
}(_QueryBuilderOperation2.default);

exports.default = UpdateOperation;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIlVwZGF0ZU9wZXJhdGlvbi5qcyJdLCJuYW1lcyI6WyJVcGRhdGVPcGVyYXRpb24iLCJuYW1lIiwib3B0IiwibW9kZWwiLCJtb2RlbE9wdGlvbnMiLCJpc1dyaXRlT3BlcmF0aW9uIiwiY2FsbCIsImJ1aWxkZXIiLCJhcmdzIiwibW9kZWxDbGFzcyIsImVuc3VyZU1vZGVsIiwib25CZWZvcmVJbnRlcm5hbCIsInJlc3VsdCIsIm1heWJlUHJvbWlzZSIsIiRiZWZvcmVVcGRhdGUiLCJjb250ZXh0Iiwib25CdWlsZCIsImtuZXhCdWlsZGVyIiwianNvbiIsIiR0b0RhdGFiYXNlSnNvbiIsImNvbHMiLCJnZXRJZENvbHVtbkFycmF5IiwiaSIsImwiLCJsZW5ndGgiLCJjb2wiLCJ1cGRhdGUiLCJvbkFmdGVySW50ZXJuYWwiLCJudW1VcGRhdGVkIiwiJGFmdGVyVXBkYXRlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUE7Ozs7QUFDQTs7OztBQUNBOzs7O0lBRXFCQSxlOzs7QUFFbkIsMkJBQVlDLElBQVosRUFBa0JDLEdBQWxCLEVBQXVCO0FBQUE7O0FBQUEsK0RBQ3JCLGlDQUFNRCxJQUFOLEVBQVlDLEdBQVosQ0FEcUI7O0FBR3JCLFVBQUtDLEtBQUwsR0FBYSxJQUFiO0FBQ0EsVUFBS0MsWUFBTCxHQUFvQixxQkFBTSxNQUFLRixHQUFMLENBQVNFLFlBQWYsS0FBZ0MsRUFBcEQ7QUFDQSxVQUFLQyxnQkFBTCxHQUF3QixJQUF4QjtBQUxxQjtBQU10Qjs7NEJBRURDLEksaUJBQUtDLE8sRUFBU0MsSSxFQUFNO0FBQ2xCLFNBQUtMLEtBQUwsR0FBYUksUUFBUUUsVUFBUixHQUFxQkMsV0FBckIsQ0FBaUNGLEtBQUssQ0FBTCxDQUFqQyxFQUEwQyxLQUFLSixZQUEvQyxDQUFiO0FBQ0EsV0FBTyxJQUFQO0FBQ0QsRzs7NEJBRURPLGdCLDZCQUFpQkosTyxFQUFTSyxNLEVBQVE7QUFDaEMsUUFBTUMsZUFBZSxLQUFLVixLQUFMLENBQVdXLGFBQVgsQ0FBeUIsS0FBS1YsWUFBOUIsRUFBNENHLFFBQVFRLE9BQVIsRUFBNUMsQ0FBckI7QUFDQSxXQUFPLCtCQUFZRixZQUFaLEVBQTBCRCxNQUExQixDQUFQO0FBQ0QsRzs7NEJBRURJLE8sb0JBQVFDLFcsRUFBYVYsTyxFQUFTO0FBQzVCLFFBQU1XLE9BQU8sS0FBS2YsS0FBTCxDQUFXZ0IsZUFBWCxFQUFiO0FBQ0EsUUFBTUMsT0FBT2IsUUFBUUUsVUFBUixHQUFxQlksZ0JBQXJCLEVBQWI7O0FBRUEsU0FBSyxJQUFJQyxJQUFJLENBQVIsRUFBV0MsSUFBSUgsS0FBS0ksTUFBekIsRUFBaUNGLElBQUlDLENBQXJDLEVBQXdDLEVBQUVELENBQTFDLEVBQTZDO0FBQzNDLFVBQU1HLE1BQU1MLEtBQUtFLENBQUwsQ0FBWjtBQUNBLGFBQU9KLEtBQUtPLEdBQUwsQ0FBUDtBQUNEOztBQUVEUixnQkFBWVMsTUFBWixDQUFtQlIsSUFBbkI7QUFDRCxHOzs0QkFFRFMsZSw0QkFBZ0JwQixPLEVBQVNxQixVLEVBQVk7QUFDbkMsUUFBTWYsZUFBZSxLQUFLVixLQUFMLENBQVcwQixZQUFYLENBQXdCLEtBQUt6QixZQUE3QixFQUEyQ0csUUFBUVEsT0FBUixFQUEzQyxDQUFyQjtBQUNBLFdBQU8sK0JBQVlGLFlBQVosRUFBMEJlLFVBQTFCLENBQVA7QUFDRCxHOzs7OztrQkFuQ2tCNUIsZSIsImZpbGUiOiJVcGRhdGVPcGVyYXRpb24uanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgY2xvbmUgZnJvbSAnbG9kYXNoL2Nsb25lJztcbmltcG9ydCBRdWVyeUJ1aWxkZXJPcGVyYXRpb24gZnJvbSAnLi9RdWVyeUJ1aWxkZXJPcGVyYXRpb24nO1xuaW1wb3J0IHthZnRlclJldHVybn0gZnJvbSAnLi4vLi4vdXRpbHMvcHJvbWlzZVV0aWxzJztcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgVXBkYXRlT3BlcmF0aW9uIGV4dGVuZHMgUXVlcnlCdWlsZGVyT3BlcmF0aW9uIHtcblxuICBjb25zdHJ1Y3RvcihuYW1lLCBvcHQpIHtcbiAgICBzdXBlcihuYW1lLCBvcHQpO1xuXG4gICAgdGhpcy5tb2RlbCA9IG51bGw7XG4gICAgdGhpcy5tb2RlbE9wdGlvbnMgPSBjbG9uZSh0aGlzLm9wdC5tb2RlbE9wdGlvbnMpIHx8IHt9O1xuICAgIHRoaXMuaXNXcml0ZU9wZXJhdGlvbiA9IHRydWU7XG4gIH1cblxuICBjYWxsKGJ1aWxkZXIsIGFyZ3MpIHtcbiAgICB0aGlzLm1vZGVsID0gYnVpbGRlci5tb2RlbENsYXNzKCkuZW5zdXJlTW9kZWwoYXJnc1swXSwgdGhpcy5tb2RlbE9wdGlvbnMpO1xuICAgIHJldHVybiB0cnVlO1xuICB9XG5cbiAgb25CZWZvcmVJbnRlcm5hbChidWlsZGVyLCByZXN1bHQpIHtcbiAgICBjb25zdCBtYXliZVByb21pc2UgPSB0aGlzLm1vZGVsLiRiZWZvcmVVcGRhdGUodGhpcy5tb2RlbE9wdGlvbnMsIGJ1aWxkZXIuY29udGV4dCgpKTtcbiAgICByZXR1cm4gYWZ0ZXJSZXR1cm4obWF5YmVQcm9taXNlLCByZXN1bHQpO1xuICB9XG5cbiAgb25CdWlsZChrbmV4QnVpbGRlciwgYnVpbGRlcikge1xuICAgIGNvbnN0IGpzb24gPSB0aGlzLm1vZGVsLiR0b0RhdGFiYXNlSnNvbigpO1xuICAgIGNvbnN0IGNvbHMgPSBidWlsZGVyLm1vZGVsQ2xhc3MoKS5nZXRJZENvbHVtbkFycmF5KCk7XG5cbiAgICBmb3IgKGxldCBpID0gMCwgbCA9IGNvbHMubGVuZ3RoOyBpIDwgbDsgKytpKSB7XG4gICAgICBjb25zdCBjb2wgPSBjb2xzW2ldO1xuICAgICAgZGVsZXRlIGpzb25bY29sXTtcbiAgICB9XG5cbiAgICBrbmV4QnVpbGRlci51cGRhdGUoanNvbik7XG4gIH1cblxuICBvbkFmdGVySW50ZXJuYWwoYnVpbGRlciwgbnVtVXBkYXRlZCkge1xuICAgIGNvbnN0IG1heWJlUHJvbWlzZSA9IHRoaXMubW9kZWwuJGFmdGVyVXBkYXRlKHRoaXMubW9kZWxPcHRpb25zLCBidWlsZGVyLmNvbnRleHQoKSk7XG4gICAgcmV0dXJuIGFmdGVyUmV0dXJuKG1heWJlUHJvbWlzZSwgbnVtVXBkYXRlZCk7XG4gIH1cbn1cbiJdfQ==